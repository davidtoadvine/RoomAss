{% extends "base_generic.html" %}
{% block content %}
{% load static %}
{% load custom_filters %}

<h1>Rooms Master</h1>
<form id="userSelectForm" method="post">
  {% csrf_token %}
  {{ user_form.user.label_tag }} {{ user_form.user }}
  <input type="hidden" name="user_form_submit" value="1">
</form>

<form id="roomSelectForm" method="post">
  {% csrf_token %}
  {{ room_form.room.label_tag }} {{ room_form.room }}
  <input type="hidden" name="room_form_submit" value="1">
</form>

{% if room %}
    <h2>{{room.name }}</h2>
    <table class="table">
      <tbody>
        <tr>
          <th>
            <div class="flex-container">
              <button class="btn-link"
              onclick="showFloorplanModal('{{room_image_url }}')">{{ room_name}}</button>
              <form id="preferenceForm-{{ room_id }}" method="post" action="{% url 'edit_guest_preferences' room_id %}">
                {% csrf_token %}
                <div class="dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="preferencesDropdownButton-{{ room_id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {% if room.owner and room.owner.preference %}
                      {{ room.owner.get_preference_display }}
                    {% else %}
                      Select Preference
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton-{{ room_id }}">
                    {% for value, display in room.owner.Preference.choices %}
                      <a class="dropdown-item" href="#" data-target="#preferenceForm-{{ room_id }}" data-value="{{ value }}">{{ display }}</a>
                    {% endfor %}

                  </div>
                  {% endif %}

                </div>
                <input type="hidden" name="preference" id="preferenceInput-{{ room_id }}">
              </form>
            </div>
          </th>
        </tr>
        {% for a_event in availability_events %}
          <tr>
            <td class="availability-cell">
              <div class="flex-container">
                <span>Available: {{ a_event.start|split_at_comma }} - {{ a_event.end|split_at_comma }}</span>
                <div>
                  <button type="button" onclick="showEditAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}', '{{room_id}}')">Edit</button>
                  <button type="button" onclick="showDeleteAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}', '{{room_id}}')">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          {% for o_event in occupancy_events %}
            {% if o_event.start >= a_event.start and o_event.end <= a_event.end %}
              <tr>
                  
                <td class="booked-cell" style="padding-left: 50px;">
                  <div class = "flex-container">

                  <span>
                  Booked: [{{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }}] --- {{ o_event.title|slice:"9:" }}
                  </span>
                  <div>
                    <button class="btn btn-primary btn-occ"
                      data-toggle="modal" 
                      data-target="#extendModal-{{ o_event.id }}" 
                      data-id="{{ o_event.id }}" 
                      data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                      data-end-date="{{ o_event.end|date:'Y-m-d' }}">Extend</button>
      
                    <button class="btn btn-primary btn-occ" 
                      data-toggle="modal" 
                      data-target="#shortenModal-{{ o_event.id }}" 
                      data-id="{{ o_event.id }}" 
                      data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                      data-end-date="{{ o_event.end|date:'Y-m-d' }}">Shorten</button>
      
                    <button class="btn btn-danger btn-occ" 
                      data-toggle="modal" 
                      data-target="#deleteModal-{{ o_event.id }}" 
                      data-id="{{ o_event.id }}" 
                      data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                      data-end-date="{{ o_event.end|date:'Y-m-d' }}">Delete</button>
                  </div>
                </div>
              </td>
              </tr>
            {% endif %}
            {% include "rooms_master_occ_modals.html" %}
          {% endfor %}
        {% endfor %}
        <tr>
          <td>            
            <button type="button" onclick="showCreateAvailabilityForm(event, '{{ room_id }}', '{{ events.room_name }}')">+ Create new availability</button>
          </td>
        </tr>
      </tbody>
    </table>

    {% for child, events in children_events.items %}
    <table class="table">
      <tbody>
        <tr>
          <th>
            <div class="flex-container">
              <button
              class="btn-link"
              onclick="showFloorplanModal('{{ events.room_image_url }}')"
            >{{ child.name}}'s Room
          </button>
              <form id="preferenceForm-{{ child.id }}" method="post" action="{% url 'edit_guest_preferences' child.id %}">
                {% csrf_token %}
                <div class="dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="preferencesDropdownButton-{{ child.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {% if child.preference %}
                      {{ child.get_preference_display }}
                    {% else %}
                      Select Preference
                    {% endif %}
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton-{{ child.id }}">
                    {% for value, display in child.Preference.choices %}
                      <a class="dropdown-item" href="#" data-target="#preferenceForm-{{ child.id }}" data-value="{{ value }}">{{ display }}</a>
                    {% endfor %}
                  </div>
                </div>
                <input type="hidden" name="preference" id="preferenceInput-{{ child.id }}">
              </form>
            </div>
          </th>
        </tr>
        {% for a_event in events.availability %}
          <tr>
            <td class="availability-cell">
              <div class="flex-container">
                <span>Available: {{ a_event.start|split_at_comma }} - {{ a_event.end|split_at_comma }}</span>
                <div>
                  <button type="button" onclick="showEditAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}', '{{room_id}}')">Edit</button>
                  <button type="button" onclick="showDeleteAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          {% for o_event in events.occupancy %}
            {% if o_event.start >= a_event.start and o_event.end <= a_event.end %}
              <tr>
                <td class="booked-cell" style="padding-left: 50px;">
                  <div class = "flex-container">

                  <span>Booked: [{{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }}] --- {{ o_event.title|slice:"9:" }}</span>
                <div>
                  <button class="btn btn-primary btn-occ"
                    data-toggle="modal" 
                    data-target="#extendModal-{{ o_event.id }}" 
                    data-id="{{ o_event.id }}" 
                    data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                    data-end-date="{{ o_event.end|date:'Y-m-d' }}">Extend</button>
    
                  <button class="btn btn-primary btn-occ" 
                    data-toggle="modal" 
                    data-target="#shortenModal-{{ o_event.id }}" 
                    data-id="{{ o_event.id }}" 
                    data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                    data-end-date="{{ o_event.end|date:'Y-m-d' }}">Shorten</button>
    
                  <button class="btn btn-danger btn-occ" 
                    data-toggle="modal" 
                    data-target="#deleteModal-{{ o_event.id }}" 
                    data-id="{{ o_event.id }}" 
                    data-start-date="{{ o_event.start|date:'Y-m-d' }}" 
                    data-end-date="{{ o_event.end|date:'Y-m-d' }}">Delete</button>
                </div>
              </div>
              </td>
              </tr>
            {% endif %}
            {% include "rooms_master_occ_modals.html" %}
          {% endfor %}
        {% endfor %}
        <tr>
          <td>
            <button type="button" onclick="showCreateAvailabilityForm(event, '{{ child.room.id }}', '{{ child.name }}')">+ Create new availability</button>
          </td>
        </tr>
      </tbody>
    </table>
{% endfor %}



{% else %}
<p></p>
<p>There is currently no room information to display.</p>
<p>Please select a User to view their room details. (Childrens' rooms are accessible via a parent User.)</p>
<p>If you have already selected a User, they appear to not have a room.</p>

{% endif %}

{%include "rooms_master_avail_modals.html"%}
{%include "rooms_master_floorplan_modal.html"%}


<script>
  // Ensure the script is loaded


  document.addEventListener('DOMContentLoaded', function() {
  
    document.getElementsByName('user')[0].onchange = function() {
      const selectedRoomId = this.value;
      const form = document.getElementById('userSelectForm');
      const url = "{% url 'rooms_master_with_room' 1 %}".replace('1', selectedRoomId);
      form.action = url;
      form.submit();
    };
  
    document.getElementsByName('room')[0].onchange = function() {
      const selectedRoomId = this.value;
      const form = document.getElementById('roomSelectForm');
      const url = "{% url 'rooms_master_with_room' 1 %}".replace('1', selectedRoomId);
      form.action = url;
      form.submit();
    };
  });


/////////////////////////////////CREATE AVAILABILITY///////////////////////////////////////////////////////////////////////
  function showCreateAvailabilityForm(event, roomId, roomName) {
    event.preventDefault();
    // Set the form values
    document.getElementById('createAvailabilityRoomId').value = roomId;
    document.getElementById('createAvailabilityPersonName').innerText = 'Create Availability for ' + roomName;
    $("#createAvailabilityRoomId").val(roomId);  // Set the user_id in the form

    
    // Show the modal
    $('#createAvailabilityModal').modal('show');
  }

  function submitCreateAvailabilityForm() {
    $("#createAvailabilityForm").submit();
  }

////////////////////////////////////CREATE -- LISTENERS AND VALIDATION//////////////////////////////////////////////////////////////////////
  // gathering date information
  var startDateInput = document.getElementById("startDate");
  var endDateInput = document.getElementById("endDate");
  var previousStartDate = startDateInput.value;
  var previousEndDate = endDateInput.value;

  // listener for start date form
  startDateInput.addEventListener("change", function () {
    if (startDateInput.value >= endDateInput.value) {
      var startDateObj = new Date(startDateInput.value);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
      endDateInput.value = endDateObj.toISOString().split("T")[0];
    }
    if (!validateDate()) {
      
    // Parse the date strings into Date objects
    var startDateObj = new Date();
    var endDateObj = new Date()

        startDateInput.value = startDateObj.toISOString().split("T")[0];

        endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
        endDateInput.value = endDateObj.toISOString().split("T")[0];    }
    else {
    previousEndDate = endDateInput.value;
  }
  });

   // listener for end date form
endDateInput.addEventListener("change", function () {
  if (!validateDate()) {
  

    // Parse the date strings into Date objects
    var startDateObj = new Date();
    var endDateObj = new Date()

        startDateInput.value = startDateObj.toISOString().split("T")[0];

        endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
        endDateInput.value = endDateObj.toISOString().split("T")[0];    }
    else {
    previousEndDate = endDateInput.value;
  }
});
  
  function validateDate() {
    var startDate = startDateInput.value;
    var endDate = endDateInput.value;
    var now = new Date();

    if (startDate && endDate) {

      // late time so if you're leaving at 5pm today and creating an availability for the night, it will be accepted
      var startDateObj = new Date(startDate + "T23:59"); //
      var endDateObj = new Date(endDate + "T11:59"); // Set time to just before noon
    
      if (startDateObj < now) {
        alert("Start date cannot be in the past.");
        return false;
      } else if (startDateObj > endDateObj) {
        alert("Invalid date range.");
        return false;
      } else {
        return true;
      }
      }
      // ?
      alert("not start and end")
      return false;
  }
   //////////////////////////////////////EDIT AVAILABILITY///////////////////////////////////////////////////////////////////////
  function showEditAvailabilityForm(eventId, start, end, roomId) {
    // Prevent default action if needed (e.g., if inside a form submission handler)
    // event.preventDefault();
    
    // Use moment.js to parse the custom date format
  const startDate = moment(start, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
  const endDate = moment(end, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
    

    
    // Set the form values
    $("#editStartDate").val(startDate);
    $("#editEndDate").val(endDate);
    $("#eventId").val(eventId);
    $("#editRoomId").val(roomId);  // Set the user_id in the form
  
    // Show the modal
    $('#editAvailabilityModal').modal('show');
  }
  function submitEditAvailabilityForm(){
    $("#editAvailabilityForm").submit();
  }

  ////////////////////////////////////EDIT -- LISTENERS AND VALIDATION//////////////////////////////////////////////////////////////////////
    // gathering date information
  var editStartDateInput = document.getElementById("editStartDate");
  var editEndDateInput = document.getElementById("editEndDate");
  var previousEditStartDate = editStartDateInput.value;
  var previousEditEndDate = editEndDateInput.value;

   // listener for start date form
  editStartDateInput.addEventListener("change", function () {
    if (editStartDateInput.value >= editEndDateInput.value) {
      var editStartDateObj = new Date(editStartDateInput.value);
      var editEndDateObj = new Date(editStartDateObj);
      editEndDateObj.setDate(editStartDateObj.getDate() + 1); // Increment end date by one day
      editEndDateInput.value = editEndDateObj.toISOString().split("T")[0];
    }
    if (!validateEditDate()) {
      editEndDateInput.value = "";  
    } else {
      previousEditStartDate = editStartDateInput.value;
    }
  });

   // listener for end date form
  editEndDateInput.addEventListener("change", function () {
    if (!validateEditDate()) {
      editEndDateInput.value = "";  
      
    } else {
      previousEditEndDate = editEndDateInput.value;
    }
  });
  
  function validateEditDate() {
    console.log('validating... start / end')
    var startDate = editStartDateInput.value;
    var endDate = editEndDateInput.value;
    var now = new Date();

    if (startDate && endDate) {
       var startDateObj = new Date(startDate + "T12:01"); // Set time to end of the day
      console.log(startDateObj)
       var endDateObj = new Date(endDate + "T11:59"); // Set time to just before noon
      console.log(endDateObj)

    if (startDateObj > endDateObj) {
        alert("Invalid date range.");
        return false;
      } else {
        return true;
      }
    }
    return true;
  }

   //////////////////////////////////////////////////////////////////////////////////////////////////////////




  $(document).ready(function() {
    $('.dropdown-item').click(function(e) {
        e.preventDefault();
        alert("Submitting your preference. \nNote: Any change to your preferences will not affect guests already scheduled for your room.");

        var preference = $(this).data('value');
        var formId = $(this).data('target');
        $(formId + ' input[name="preference"]').val(preference);
        $(formId).submit();
    });

});


function showDeleteAvailabilityForm(eventId, start, end, roomId) {
  event.preventDefault();
  // Set the form values
   // Use moment.js to parse the custom date format
   const startDate = moment(start, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
   const endDate = moment(end, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
     
     
     // Set the form values
     $("#deleteStartDate").val(startDate);
     $("#deleteEndDate").val(endDate);
     $("#deleteEventId").val(eventId);
     $("#editRoomId").val(roomId);  // Set the user_id in the form

  // Show the modal
  $('#deleteAvailabilityModal').modal('show');
}

function submitDeleteAvailabilityForm() {
  $("#deleteAvailabilityForm").submit();
}

$(document).ready(function() {
  $('#floorplanModal').on('shown.bs.modal', function () {
      console.log('Image src:', $('#floorplanModal img').attr('src'));
  });
});


 // Function to show the floorplan modal with the correct image
 function showFloorplanModal(imageUrl) {
  document.getElementById('floorplanImage').src = imageUrl;
  $('#floorplanModal').modal('show');
}






//////////////////////////////////////////////////////////////////////////////////
$(document).ready(function() {
  
  console.log("Document is ready!");

  // Log message to confirm buttons are clicked
  document.querySelectorAll('.btn-occ').forEach(function(button) {
    button.addEventListener('click', function() {
        console.log("Button clicked!!!");

        // Log data attributes
        console.log('pre attributes...');

        console.log('Data ID:', button.getAttribute('data-id'));
        console.log('Data Start Date:', button.getAttribute('data-start-date'));
        console.log('Data End Date:', button.getAttribute('data-end-date'));
        console.log('post attributes...');
    });
});



  // Function to populate the extend modal

  // $('.modal').on('show.bs.modal', function(event) {
 //  console.log("Modal is being shown!");
 //  var button = $(event.relatedTarget);
 //  var eventId = button.data('id');
 //  var startDate = button.data('start-date');
 //  var endDate = button.data('end-date');
 //  
 //  console.log(`Opening modal for event ${eventId} with start date ${startDate} and end date ${endDate}`);

 //  var modal = $(this);
 //  modal.find(`#extendEventId-${eventId}`).val(eventId);
 //  modal.find(`#extendStartDate-${eventId}`).val(startDate);
 //  modal.find(`#extendEndDate-${eventId}`).val(endDate);

 //  // Set the original start and end date data attributes
 //  modal.find(`#extendStartDate-${eventId}`).attr('data-original-start', startDate);
 //  modal.find(`#extendEndDate-${eventId}`).attr('data-original-end', endDate);

 //  // Similar setup for shorten modal
 //  modal.find(`#shortenEventId-${eventId}`).val(eventId);
 //  modal.find(`#shortenStartDate-${eventId}`).val(startDate);
 //  modal.find(`#shortenEndDate-${eventId}`).val(endDate);
 //  
 //  modal.find(`#shortenStartDate-${eventId}`).attr('data-original-start', startDate);
 //  modal.find(`#shortenEndDate-${eventId}`).attr('data-original-end', endDate);
 //});

  // Populate modals with data attributes
  $('.modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var eventId = button.data('id');
    var startDate = button.data('start-date');
    var endDate = button.data('end-date');

    var modal = $(this);
    modal.find(`#extendEventId-${eventId}`).val(eventId);
    modal.find(`#extendStartDate-${eventId}`).val(startDate);
    modal.find(`#extendEndDate-${eventId}`).val(endDate);

    // Set the original start and end date data attributes
    modal.find(`#extendStartDate-${eventId}`).attr('data-original-start', startDate);
    modal.find(`#extendEndDate-${eventId}`).attr('data-original-end', endDate);
    // Similar setup for shorten modal
    modal.find(`#shortenEventId-${eventId}`).val(eventId);
    modal.find(`#shortenStartDate-${eventId}`).val(startDate);
    modal.find(`#shortenEndDate-${eventId}`).val(endDate);
    
    modal.find(`#shortenStartDate-${eventId}`).attr('data-original-start', startDate);
    modal.find(`#shortenEndDate-${eventId}`).attr('data-original-end', endDate);
  });

function submitExtendForm() {
            console.log("Extend form submitted!");
            document.getElementById('extendForm').submit();
        }

  });


// Function to validate date selection
function validateExtendDate(eventId) {
  console.log(`Validating extend date for event ${eventId}`);
  let startDateInput = document.getElementById(`extendStartDate-${eventId}`);
  let endDateInput = document.getElementById(`extendEndDate-${eventId}`);
  let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
  let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
  let newStartDate = new Date(startDateInput.value);
  let newEndDate = new Date(endDateInput.value);

  if (newStartDate > originalStartDate || newEndDate < originalEndDate) {
    alert("New dates cannot shrink the original reservation window. Please use the 'Shorten' button for that.");
    startDateInput.value = startDateInput.getAttribute('data-original-start');
    endDateInput.value = endDateInput.getAttribute('data-original-end');
  }
}

// Attach change event listeners to the date inputs
$(document).on('change', '.extend-start-date, .extend-end-date', function() {
  const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
  validateExtendDate(eventId);
});

function validateShortenDate(eventId) {
  console.log(`Validating shorten date for event ${eventId}`);
  let startDateInput = document.getElementById(`shortenStartDate-${eventId}`);
  let endDateInput = document.getElementById(`shortenEndDate-${eventId}`);
  let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
  let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
  let newStartDate = new Date(startDateInput.value);
  let newEndDate = new Date(endDateInput.value);

  if (newStartDate < originalStartDate || newEndDate > originalEndDate) {
    alert("New dates cannot extend the original reservation window. Please use the 'Extend' button for that.");
    startDateInput.value = startDateInput.getAttribute('data-original-start');
    endDateInput.value = endDateInput.getAttribute('data-original-end');
  }
  else if (newStartDate >= originalEndDate || newEndDate <= originalStartDate){
    alert("The start date cannot occur on or after the end date. If you wish to delete this event, please use the 'Delete' button.");
    startDateInput.value = startDateInput.getAttribute('data-original-start');
    endDateInput.value = endDateInput.getAttribute('data-original-end');
  }
} 

// Attach change event listeners to the date inputs
$(document).on('change', '.shorten-start-date, .shorten-end-date', function() {
  const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
  validateShortenDate(eventId);
});

function submitExtendForm(eventId) {
  document.getElementById(`extendForm-${eventId}`).submit();
}

function submitShortenForm(eventId) {
  document.getElementById(`shortenForm-${eventId}`).submit();
}
</script>
{% endblock %}