{% extends "base_generic.html" %}
{% block content %}
{% load static %}
{% load custom_filters %}



{% block extra_css %}
<link rel="stylesheet" href="{% static 'catalog/css/my_room.css' %}">
{% endblock %}


<h1>Rooms Master</h1>

<div id = "box-rooms-master-forms">

<form id="person-select-form" method="post">
  {% csrf_token %}
  {{ person_form.person.label_tag }} {{ person_form.person }}
  <input type="hidden" name="person_form_submit" value="1">
</form>

<form id="room-select-form" method="post">
  {% csrf_token %}
  {{ room_form.room.label_tag }} {{ room_form.room }}
  <input type="hidden" name="room_form_submit" value="1">
</form>

<form id="section-select-form" method="post">
  {% csrf_token %}
  {{ section_form.section.label_tag }} {{ section_form.section }}
  <input type="hidden" name="section_form_submit" value="1">
</form> 







{% comment %}  FOR SELECTION BY BUILDING SECTION {% endcomment %}

</div>
{% if selected_section%}
<h2 id = "user-title">{{section_title}}</h2>

{% for room, room_info in section_events.items %}

    <table class="table">
      <tbody>
        <tr>
          <th>
            <div class="flex-container">

              {%if room.owner%}
              <div class="button-group">

              <button
              class="btn-link"
              onclick="showFloorplanModal('{{ room_info.room_image_url }}', '{{room_info.room_name}}')"
            >{{room_info.room_title}}           {%if room.is_offline%}<strong style= "color:red;"> *OFFLINE*</strong>{%endif%}

          </button>
          <button type="button" class="btn btn-danger owner-button" data-toggle="modal" data-target="#remove-owner-modal" data-room-id="{{ room.id }}">Remove Owner</button>
        </div>

              <form id="preference-form-{{ room.id }}" method="post" action="{% url 'edit_guest_preferences_with_section' room_info.room_id room_info.owner_id section_id%}">
                {% csrf_token %}
                <div class="dropdown preference-dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="preferences-dropdown-button-{{ room.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {% if room.owner.preference %}
                      {{ room.owner.get_preference_display }}
                    {% else %}
                      Select Preference
                    {% endif %}
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdown-menu-button-{{ room.id }}">
                    {% for value, display in room.owner.Preference.choices %}
                      <a class="dropdown-item preference-dropdown-item" href="#" data-target="#preference-form-{{ room.id }}" data-value="{{ value }}">{{ display }}</a>
                    {% endfor %}
                  </div>
                </div>
                <input type="hidden" name="preference" id="preference-input-{{ room.id }}">
              </form>

              {%else%}
              <div class="button-group">
                  <button class="btn-link" onclick="showFloorplanModal('{{ room_info.room_image_url }}', '{{ room_info.room_name }}')">{{room_info.room_title }} {%if room.is_offline%}<strong style= "color:red;"> *OFFLINE*</strong>{%endif%}</button>
                  <form id="assign-owner-form-{{ room_info.room_id }}" method="post" action="{% if section_id %}{% url 'assign_owner_with_section' room_info.room_id section_id %}{% else %}{% url 'assign_owner' room_info.room_id %}{% endif %}" style="display: inline;">
                    {% csrf_token %}
                    <div class="dropdown" style="display: inline;">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="roomless-members-dropdown-{{ room_info.room_id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Assign Roomless Member
                        </button>
                        <div class="dropdown-menu" aria-labelledby="roomless-members-dropdown-{{ room_info.room_id }}">
                            {% for member in roomless_members %}
                                <a class="dropdown-item" href="#" onclick="selectMember('{{ member.id }}', 'assign-owner-form-{{ room_info.room_id }}', 'member-id-input-{{ room_info.room_id }}')">{{ member.name }}</a>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="member_id" id="member-id-input-{{ room_info.room_id }}">
                </form>
                </div>

                  <button id = "btn-preference-grey" class="btn btn-secondary">Anyone can stay here</button>
              {% endif %}
            </div>
          </th>
        </tr>
        {%if room_info.events_exist%}
        {% for a_event in room_info.availability_events %}
          <tr>
            <td class="availability-cell">
              <div class="flex-container">
                <span><em>Made Available:</em> {{ a_event.start|split_at_second_comma }} - {{ a_event.end|split_at_second_comma }}</span>
                <div>
                  <button class = "btn-grey" type="button" onclick="showEditAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Edit</button>
                  <button class = "btn-grey" type="button" onclick="showDeleteAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          {% for o_event in room_info.occupancy_events_and_vacancies %}
          {% if o_event.start >= a_event.start and o_event.end <= a_event.end %}

              {% if o_event.type == "Booked"%}
              <tr>
              <td class = "booked-cell" style="padding-left: 50px;" >
                <div class = "flex-container">

                <span class ="booked-text">
                {%if forloop.last and not room.owner%}
                    <em>Booked:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_second_comma }} --- {{ o_event.title|slice:"9:" }}
                    {%else%}
                    <em>Booked:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }} --- {{ o_event.title|slice:"9:" }}
                    {%endif%}
              </span>
              <div>
                <button class="btn-grey"
                data-toggle="modal" 
                data-target="#extend-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Extend</button>

            <button class="btn-grey" 
                data-toggle="modal" 
                data-target="#shorten-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Shorten</button>

            <button class="bt-grey" 
                data-toggle="modal" 
                data-target="#delete-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Delete</button>
              </div>
            </div>
            </td>
          </tr>
          {% comment %} {% include "booking_modals.html" %} {% endcomment %}

              {%else%}
              <tr>
                <td class = "not-booked-cell" style="padding-left: 50px;" >

                  <span class ="booked-text">
                    {%if forloop.last and not room.owner%}
                    <em>Vacant:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_second_comma }} 
                    {%else%}
                    <em>Vacant:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }}
                    {%endif%}
                </span>
              </td>
            </tr>
            {% endif %}

            {% endif %}
          {% endfor %}
        {% endfor %}
        
      {%else%}
      <tr><td class = "no-availabilities-cell">No scheduled availabilities.</td></tr>
      {%endif%}
        <tr>
          <td class= "cell-create-availability">
                        <button class = "btn-grey" type="button" onclick="showCreateAvailabilityForm(event, '{{ room.id }}', '{{ room.owner.name }}')">+ Create new availability</button>
          </td>
        </tr>
      </tbody>
    </table>
{% endfor %}







{% comment %}  FOR SELECTION BY ROOM {% endcomment %}
{% elif room %}
    {%if room.owner%}
    <h2 id = "user-title">{{room.owner }}'s Room</h2>
    {%else%}
    <h2 id = "user-title">{{room_name}}</h2>
    {%endif%}
    <table class="table">
      <tbody>
        <tr>
          <th>
            
            <div class="flex-container">
              {% if room.owner %}
              <div class="button-group">
                  <button class="btn-link" onclick="showFloorplanModal('{{ room_image_url }}', '{{ room_name }}')">{{ room.owner }}'s Room</button>
                  <button type="button" class="btn btn-danger owner-button" data-toggle="modal" data-target="#remove-owner-modal" data-room-id="{{ room.id }}">Remove Owner</button>
              </div>
              <form id="preference-form-{{ room.owner.id }}" method="post" action="{% url 'edit_guest_preferences' room.id room.owner.id %}">
                  {% csrf_token %}
                  <div class="dropdown preference-dropdown">
                      <button class="btn btn-secondary dropdown-toggle" type="button" id="preferences-dropdown-button-{{ room.owner.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          {% if room.owner.preference %}
                          {{ room.owner.get_preference_display }}
                          {% else %}
                          Select Preference
                          {% endif %}
                      </button>
                      <div class="dropdown-menu" aria-labelledby="preferences-dropdown-button-{{ room.owner.id }}">
                          {% for value, display in room.owner.Preference.choices %}
                          <a class="dropdown-item preference-dropdown-item" href="#" onclick="selectPreference('{{ value }}', '{{ room.owner.id }}')">{{ display }}</a>
                          {% endfor %}
                      </div>
                  </div>
                  <input type="hidden" name="preference" id="preference-input-{{ room.owner.id }}">
              </form>
              {% else %}
              <div class="button-group">
                  <button class="btn-link" onclick="showFloorplanModal('{{ room_image_url }}', '{{ room_name }}')">{{ room_name }}</button>
                  <form id="assign-owner-form-{{ room_id }}" method="post" action="{% if section_id %}{% url 'assign_owner_with_section' room.id section_id %}{% else %}{% url 'assign_owner' room.id %}{% endif %}" style="display: inline;">
                    {% csrf_token %}
                    <div class="dropdown" style="display: inline;">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="roomless-members-dropdown-{{ room.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Assign Roomless Member
                        </button>
                        <div class="dropdown-menu" aria-labelledby="roomless-members-dropdown-{{ room.id }}">
                            {% for member in roomless_members %}
                                <a class="dropdown-item" href="#" onclick="selectMember('{{ member.id }}', 'assign-owner-form-{{ room.id }}', 'member-id-input-{{ room.id }}')">{{ member.name }}</a>
                            {% endfor %}
                        </div>
                    </div>
                    <input type="hidden" name="member_id" id="member-id-input-{{ room.id }}">
                </form>
                </div>

                  <button id = "btn-preference-grey" class="btn btn-secondary">Anyone can stay here</button>
              {% endif %}
          </div>

          </th>
        </tr>
        {%if events_exist%}
        {% for a_event in availability_events %}
          <tr>
            <td class="availability-cell">
              <div class="flex-container">
                <span><em>Made Available:</em> {{ a_event.start|split_at_second_comma }} - {{ a_event.end|split_at_second_comma}}</span>
                <div>
                  <button class = "btn-grey" type="button" onclick="showEditAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Edit</button>
                  <button class = "btn-grey" type="button" onclick="showDeleteAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          

          {% for o_event in occupancy_events_and_vacancies %}
          {% if o_event.start >= a_event.start and o_event.end <= a_event.end %}

              {% if o_event.type == "Booked"%}
              <tr>
              <td class = "booked-cell" style="padding-left: 50px;" >
                <div class = "flex-container">

                <span class ="booked-text">
                  {%if forloop.last and not room.owner%}
                  <em>Booked:</em> {{ o_event.start|split_at_second_comma }} - {{ o_event.end|split_at_second_comma }} --- {{ o_event.title|slice:"9:" }}
                  {%else%}
                  <em>Booked:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }} --- {{ o_event.title|slice:"9:" }}
                  {%endif%}
              </span>
              <div>
                <button class="btn-grey"
                  data-toggle="modal" 
                  data-target="#extend-booking-modal" 
                  data-id="{{ o_event.event.id }}" 
                  data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                  data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Extend</button>
  
                <button class="btn-grey" 
                  data-toggle="modal" 
                  data-target="#shorten-booking-modal" 
                  data-id="{{ o_event.event.id }}" 
                  data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                  data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Shorten</button>
  
                <button class="bt-grey" 
                  data-toggle="modal" 
                  data-target="#delete-booking-modal" 
                  data-id="{{ o_event.event.id }}" 
                  data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                  data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Delete</button>
              </div>
            </div>
            </td>
          </tr>
          {% comment %} {% include "booking_modals.html" %} {% endcomment %}

              {%else%}
              <tr>
                <td class = "not-booked-cell" style="padding-left: 50px;" >

                  <span class ="booked-text">
                    {%if forloop.last and not room.owner%}
                    <em>Vacant:</em> {{ o_event.start|split_at_second_comma }} - {{ o_event.end|split_at_second_comma }} 
                    {%else%}
                    <em>Vacant:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }} 
        
                    {%endif%}
                </span>
              </td>
            </tr>
            {%endif%}
            {% endif %}
          {% endfor %}
        {% endfor %}

        {%else%}
        <tr><td class = "no-availabilities-cell">No scheduled availabilities.</td></tr>
        {%endif%}

        <tr>
          <td class= "cell-create-availability">
          <button class = "btn-grey" type="button" onclick="showCreateAvailabilityForm(event, '{{ room_id }}', '{{ .room_name }}')">+ Create new availability</button>
          </td>
        </tr>
      </tbody>
    </table>

    {% for child, room_info  in children_info.items %}
    <table class="table">
      <tbody>
        <tr>
          <th>
            <div class="flex-container">
              <button
              class="btn-link"
              onclick="show-floorplan-modal('{{ .room_image_url }}', '{{.room_name}}')"
            >{{ child.name}}'s Room
          </button>
              <form id="preference-form-{{ child.id }}" method="post" action="{% url 'edit_guest_preferences' room_id child.id %}">
                {% csrf_token %}
                <div class="dropdown preference-dropdown">
                  <button class="btn btn-secondary dropdown-toggle" type="button" id="preferences-dropdown-button-{{ child.id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {% if child.preference %}
                      {{ child.get_preference_display }}
                    {% else %}
                      Select Preference
                    {% endif %}
                  </button>
                  <div class="dropdown-menu" aria-labelledby="dropdown-menu-button-{{ child.id }}">
                    {% for value, display in child.Preference.choices %}
                      <a class="dropdown-item preference-dropdown-item" href="#" data-target="#preference-form-{{ child.id }}" data-value="{{ value }}">{{ display }}</a>
                    {% endfor %}
                  </div>
                </div>
                <input type="hidden" name="preference" id="preference-input-{{ child.id }}">
              </form>
            </div>
          </th>
        </tr>
        {%if room_info.events_exist%}
        {% for a_event in room_info.availability_events %}
          <tr>
            <td class="availability-cell">
              <div class="flex-container">
                <span><em>Made Available:</em> {{ a_event.start|split_at_comma }} - {{ a_event.end|split_at_comma }}</span>
                <div>
                  <button class = "btn-grey" type="button" onclick="showEditAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}', '{{room_id}}')">Edit</button>
                  <button class = "btn-grey" type="button" onclick="showDeleteAvailabilityForm('{{ a_event.id }}', '{{ a_event.start }}', '{{ a_event.end }}')">Delete</button>
                </div>
              </div>
            </td>
          </tr>
          {% for o_event in room_info.occupancy_events_and_vacancies %}
            {% if o_event.start >= a_event.start and o_event.end <= a_event.end %}
            {% if o_event.type == "Booked"%}
            <tr>
            <td class = "booked-cell" style="padding-left: 50px;" >
              <div class = "flex-container">

              <span class ="booked-text">
                
                {%if forloop.last and not room.owner%}
                <em>Booked:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_second_comma }} --- {{ o_event.title|slice:"9:" }}
                {%else%}
                <em>Booked:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }} --- {{ o_event.title|slice:"9:" }}
                {%endif%}            </span>
            <div>
              <button class="btn-grey"
                data-toggle="modal" 
                data-target="#extend-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Extend</button>

              <button class="btn-grey" 
                data-toggle="modal" 
                data-target="#shorten-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Shorten</button>

              <button class="bt-grey" 
                data-toggle="modal" 
                data-target="#delete-booking-modal" 
                data-id="{{ o_event.event.id }}" 
                data-start-date="{{ o_event.event.start|date:'Y-m-d' }}" 
                data-end-date="{{ o_event.event.end|date:'Y-m-d' }}">Delete</button>
            </div>
          </div>
          </td>
        </tr>
        {% comment %} {% include "booking_modals.html" %} {% endcomment %}

            {%else%}

            <tr>
              <td class = "not-booked-cell" style="padding-left: 50px;" >

                <span class ="booked-text">
                  {%if forloop.last and not room.owner%}
                  <em>Vacant:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_second_comma }} 
                  {%else%}
                  <em>Vacant:</em> {{ o_event.start|split_at_comma }} - {{ o_event.end|split_at_comma }}
      
                  {%endif%}   
              </span>
            </td>
          </tr>
          {%endif%}
            {% endif %}
            {% comment %} {% include "booking_modals.html" %} {% endcomment %}
          {% endfor %}
        {% endfor %}
        
      {%else%}
      <tr><td class = "no-availabilities-cell">No scheduled availabilities.</td></tr>
      {%endif%}
        <tr>
          <td class= "cell-create-availability">
                        <button class = "btn-grey" type="button" onclick="showCreateAvailabilityForm(event, '{{ child.room.id }}', '{{ child.name }}')">+ Create new availability</button>
          </td>
        </tr>
      </tbody>
    </table>
{% endfor %}

{% else %}
<p></p>
<p>There is currently no room information to display.</p>
<p>Select rooms above to view details.</p>

{% endif %}

{%include "availability_modals.html"%}
{%include "floorplan_img_modal.html"%}
{% include "booking_modals.html" %}


<!-- Modal HTML -->
<div class="modal fade" id="remove-owner-modal" tabindex="-1" role="dialog" aria-labelledby="remove-owner-modal-label" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="remove-owner-modal-label">Remove Owner</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to add the owner from this room?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <form method="POST"
        action="{%if section_id%}{% url 'remove_owner_with_section' section_id %}
        {%else%}{%url 'remove_owner'%} {%endif%}"
        
         
          id="remove-owner-form">
          {% csrf_token %}
          <input type="hidden" name="room_id" id="room_id">
          <button type="submit" class="btn btn-danger">Remove Owner</button>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
  // Ensure the script is loaded

  document.addEventListener('DOMContentLoaded', function() {
    const personSelectElement = document.getElementsByName('person')[0];
    const roomSelectElement = document.getElementsByName('room')[0];
    const sectionSelectElement = document.getElementsByName('section')[0];

    if (personSelectElement) {
      personSelectElement.onchange = function() {
        const selectedPersonId = this.value;
        const form = document.getElementById('person-select-form');
        const url = "{% url 'rooms_master_with_room' 1 %}".replace('1', selectedPersonId);
        form.action = url;
        form.submit();
      };
    }

    if (roomSelectElement) {
      roomSelectElement.onchange = function() {
        const selectedRoomId = this.value;
        const form = document.getElementById('room-select-form');
        const url = "{% url 'rooms_master_with_room' 1 %}".replace('1', selectedRoomId);
        form.action = url;
        form.submit();
      };
    }

   if (sectionSelectElement) {
     sectionSelectElement.onchange = function() {
       const selectedSectionId = this.value;
       const form = document.getElementById('section-select-form');
       const url = "{% url 'rooms_master_with_section' 1 %}".replace('1', selectedSectionId);
       form.action = url;
       form.submit();
     };
   } 
  });


/////////////////////////////////CREATE AVAILABILITY///////////////////////////////////////////////////////////////////////
  function showCreateAvailabilityForm(event, roomId, roomName) {
    event.preventDefault();
    // Set the form values
    document.getElementById('create-availability-room-id').value = roomId;
    document.getElementById('create-availability-person-name').innerText = 'Create Availability for ' + roomName;
    $("#create-availability-room-id").val(roomId);  

    
    // Show the modal
    $('#create-availability-modal').modal('show');
  }

  function submitCreateAvailabilityForm() {
    $("#create-availability-form").submit();
  }

////////////////////////////////////CREATE -- LISTENERS AND VALIDATION//////////////////////////////////////////////////////////////////////
  // gathering date information
  var startDateInput = document.getElementById("create-availability-start-date");
  var endDateInput = document.getElementById("create-availability-end-date");
  var previousStartDate = startDateInput.value;
  var previousEndDate = endDateInput.value;

  // listener for start date form
  startDateInput.addEventListener("change", function () {
    if (startDateInput.value >= endDateInput.value) {
      var startDateObj = new Date(startDateInput.value);
      var endDateObj = new Date(startDateObj);
      endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
      endDateInput.value = endDateObj.toISOString().split("T")[0];
    }
    if (!validateDate()) {
      
    // Parse the date strings into Date objects
    var startDateObj = new Date();
    var endDateObj = new Date()

        startDateInput.value = startDateObj.toISOString().split("T")[0];

        endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
        endDateInput.value = endDateObj.toISOString().split("T")[0];    }
    else {
    previousEndDate = endDateInput.value;
  }
  });

   // listener for end date form
endDateInput.addEventListener("change", function () {
  if (!validateDate()) {
  

    // Parse the date strings into Date objects
    var startDateObj = new Date();
    var endDateObj = new Date()

        startDateInput.value = startDateObj.toISOString().split("T")[0];

        endDateObj.setDate(startDateObj.getDate() + 1); // Increment end date by one day
        endDateInput.value = endDateObj.toISOString().split("T")[0];    }
    else {
    previousEndDate = endDateInput.value;
  }
});
  
  function validateDate() {
    var startDate = startDateInput.value;
    var endDate = endDateInput.value;
    var now = new Date();

    if (startDate && endDate) {

      // late time so if you're leaving at 5pm today and creating an availability for the night, it will be accepted
      var startDateObj = new Date(startDate + "T23:59"); //
      var endDateObj = new Date(endDate + "T11:59"); // Set time to just before noon
    
      if (startDateObj < now) {
        alert("Start date cannot be in the past.");
        return false;
      } else if (startDateObj > endDateObj) {
        alert("Invalid date range.");
        return false;
      } else {
        return true;
      }
      }
      // ?
      alert("not start and end")
      return false;
  }
   //////////////////////////////////////EDIT AVAILABILITY///////////////////////////////////////////////////////////////////////
  function showEditAvailabilityForm(eventId, start, end, redirectId) {
    // Prevent default action if needed (e.g., if inside a form submission handler)
    // event.preventDefault();

    // Use moment.js to parse the custom date format
  const startDate = moment(start, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
  const endDate = moment(end, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
    

    
    // Set the form values
    $("#edit-availability-start-date").val(startDate);
    $("#edit-availability-end-date").val(endDate);
    $("#edit-availability-event-id").val(eventId);
    //$("#editRedirectId").val(redirectId);  
// Log values to debug
console.log("Event ID:", eventId);
console.log("Start Date:", startDate);
console.log("End Date:", endDate);
console.log("Room ID:", redirectId);

  
    // Show the modal
    $('#edit-availability-modal').modal('show');
  }
  function submitEditAvailabilityForm(){
    $("#edit-availability-form").submit();
  }

  ////////////////////////////////////EDIT -- LISTENERS AND VALIDATION//////////////////////////////////////////////////////////////////////
    // gathering date information
  var editStartDateInput = document.getElementById("edit-availability-start-date");
  var editEndDateInput = document.getElementById("edit-availability-end-date");
  var previousEditStartDate = editStartDateInput.value;
  var previousEditEndDate = editEndDateInput.value;

   // listener for start date form
  editStartDateInput.addEventListener("change", function () {
    if (editStartDateInput.value >= editEndDateInput.value) {
      var editStartDateObj = new Date(editStartDateInput.value);
      var editEndDateObj = new Date(editStartDateObj);
      editEndDateObj.setDate(editStartDateObj.getDate() + 1); // Increment end date by one day
      editEndDateInput.value = editEndDateObj.toISOString().split("T")[0];
    }
    if (!validateEditDate()) {
      editEndDateInput.value = "";  
    } else {
      previousEditStartDate = editStartDateInput.value;
    }
  });

   // listener for end date form
  editEndDateInput.addEventListener("change", function () {
    if (!validateEditDate()) {
      editEndDateInput.value = "";  
      
    } else {
      previousEditEndDate = editEndDateInput.value;
    }
  });
  
  function validateEditDate() {
    console.log('validating... start / end')
    var startDate = editStartDateInput.value;
    var endDate = editEndDateInput.value;
    var now = new Date();

    if (startDate && endDate) {
       var startDateObj = new Date(startDate + "T12:01"); // Set time to end of the day
      console.log(startDateObj)
       var endDateObj = new Date(endDate + "T11:59"); // Set time to just before noon
      console.log(endDateObj)

    if (startDateObj > endDateObj) {
        alert("Invalid date range.");
        return false;
      } else {
        return true;
      }
    }
    return true;
  }

   //////////////////////////////////////////////////////////////////////////////////////////////////////////

  $(document).ready(function() {
    $('.preference-dropdown-item').click(function(e) {
        e.preventDefault();
        //alert("Submitting your preference. \nNote: Any change to your preferences will not affect guests already scheduled for your room.");

        var preference = $(this).data('value');
        var formId = $(this).data('target');
        $(formId + ' input[name="preference"]').val(preference);
        $(formId).submit();
    });

});


function showDeleteAvailabilityForm(eventId, start, end) {
  event.preventDefault();
  // Set the form values
   // Use moment.js to parse the custom date format
   const startDate = moment(start, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
   const endDate = moment(end, 'MMMM D, YYYY, h:mm a').format('YYYY-MM-DD');
     
     
     // Set the form values
     $("#delete-availability-start-date").val(startDate);
     $("#delete-availability-end-date").val(endDate);
     $("#delete-availability-event-id").val(eventId);
     //$("#editRoomId").val(roomId);  

  // Show the modal
  $('#delete-availability-modal').modal('show');
}

function submitDeleteAvailabilityForm() {
  $("#delete-availability-form").submit();
}

$(document).ready(function() {
  $('#floorplan-modal').on('shown.bs.modal', function () {
      console.log('Image src:', $('#floorplan-modal img').attr('src'));
  });
});


 // Function to show the floorplan modal with the correct image
 function showFloorplanModal(imageUrl, roomName) {
  document.getElementById('floorplan-image').src = imageUrl;
  document.getElementById('floorplan-modal-label').innerText = roomName;

  $('#floorplan-modal').modal('show');
}






//////////////////////////////////////////////////////////////////////////////////
$(document).ready(function() {
  // Log message to confirm buttons are clicked
  document.querySelectorAll('.btn-occ').forEach(function(button) {
    button.addEventListener('click', function() {
        console.log("Button clicked!!!");
        console.log('Data ID:', button.getAttribute('data-id'));
        console.log('Data Start Date:', button.getAttribute('data-start-date'));
        console.log('Data End Date:', button.getAttribute('data-end-date'));
    });
  });

  // Populate modals with data attributes
  $('.modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var eventId = button.data('id');
    console.log("Event id is " + eventId);
    var startDate = button.data('start-date');
    var endDate = button.data('end-date');
    var modal = $(this);



    modal.find(`#delete-booking-event-id`).val(eventId);

    modal.find(`#extend-booking-event-id`).val(eventId);
    modal.find(`#extend-booking-start-date`).val(startDate);
    modal.find(`#extend-booking-end-date`).val(endDate);

    modal.find(`#extend-booking-start-date`).attr('data-original-start', startDate);
    modal.find(`#extend-booking-end-date`).attr('data-original-end', endDate);

    modal.find(`#shorten-booking-event-id`).val(eventId);
    modal.find(`#shorten-booking-start-date`).val(startDate);
    modal.find(`#shorten-booking-end-date`).val(endDate);
    
    modal.find(`#shorten-booking-start-date`).attr('data-original-start', startDate);
    modal.find(`#shorten-booking-end-date`).attr('data-original-end', endDate);
  });
  $('#extend-booking-modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var sectionId = "{{ section_id|default:'' }}";
    var eventId = button.data('id');
    var modal = $(this);
    // Update the form action URL
    let formAction = '';
    if (sectionId) {
      formAction = `/catalog/extend_booking/${eventId}/${sectionId}/`;
    } else {
      formAction = `/catalog/extend_booking/${eventId}/`;
    }
    modal.find('#extend-booking-form').attr('action', formAction);
  });
  $('#shorten-booking-modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var sectionId = "{{ section_id|default:'' }}";
    var eventId = button.data('id');
    var modal = $(this);
    // Update the form action URL
    let formAction = '';
    if (sectionId) {
      formAction = `/catalog/shorten_booking/${eventId}/${sectionId}/`;
    } else {
      formAction = `/catalog/shorten_booking/${eventId}/`;
    }
    modal.find('#shorten-booking-form').attr('action', formAction);
  });
  $('#delete-booking-modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var sectionId = "{{ section_id|default:'' }}";
    var eventId = button.data('id');
    var modal = $(this);
    // Update the form action URL
    let formAction = '';
    if (sectionId) {
      formAction = `/catalog/delete_booking/${eventId}/${sectionId}/`;
    } else {
      formAction = `/catalog/delete_booking/${eventId}/`;
    }
    modal.find('#delete-booking-form').attr('action', formAction);
  });

});

  // Function to validate date selection for extending
  function validateExtendDate(eventId) {
    console.log(`Validating extend date for event ${eventId}`);
    let startDateInput = document.getElementById(`extend-booking-start-date`);
    let endDateInput = document.getElementById(`extend-booking-end-date`);
    let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
    let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
    let newStartDate = new Date(startDateInput.value);
    let newEndDate = new Date(endDateInput.value);

    if (newStartDate > originalStartDate || newEndDate < originalEndDate) {
      alert("New dates cannot shrink the original reservation window. Please use the 'Shorten' button for that.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    }
    return true;
  }

  // Function to validate date selection for shortening
  function validateShortenDate(eventId) {
    console.log(`Validating shorten date for event ${eventId}`);
    let startDateInput = document.getElementById(`shorten-booking-start-date`);
    let endDateInput = document.getElementById(`shorten-booking-end-date`);
    let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
    let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
    let newStartDate = new Date(startDateInput.value);
    let newEndDate = new Date(endDateInput.value);

    if (newStartDate < originalStartDate || newEndDate > originalEndDate) {
      alert("New dates cannot extend the original reservation window. Please use the 'Extend' button for that.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    } else if (newStartDate >= originalEndDate || newEndDate <= originalStartDate){
      alert("The start date cannot occur on or after the end date. If you wish to delete this event, please use the 'Delete' button.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    }
    return true;
  }

  // Attach change event listeners to the date inputs
  $(document).on('change', '.extend-booking-start-date, .extend-booking-end-date', function() {
    const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
    validateExtendDate(eventId);
  });

  $(document).on('change', '.shorten-booking-start-date, .shorten-booking-end-date', function() {
    const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
    validateShortenDate(eventId);
  });

  


function submitExtendBookingForm(eventId) {
  var form = $(`#extend-booking-form`);
  var formData = form.serialize();

  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        if (response.redirect_url) {
          window.location.href = response.redirect_url;
        } else {
          location.reload();  // Optionally, reload the page to reflect changes
        }
      } else if (response.status === 'error') {
        displayFormErrors(form, response.errors);
      } else if (response.status === 'conflict') {
        alert(`Conflict detected: Start - ${response.start}, End - ${response.end}`);
      }
    },
    error: function(xhr, status, error) {
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}
function submitShortenBookingForm(eventId) {
  var form = $(`#shorten-booking-form`);
  var formData = form.serialize();

  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        if (response.redirect_url) {
          window.location.href = response.redirect_url;
        } else {
          location.reload();  // Optionally, reload the page to reflect changes
        }
      } else if (response.status === 'error') {
        displayFormErrors(form, response.errors);
      }
    },
    error: function(xhr, status, error) {
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}
// Function to submit delete form
function submitDeleteBookingForm() {
  console.log("SUBMITTING DELETE FORM")
  var form = $(`#delete-booking-form`);
  console.log(form)
  var csrfTokenInput = form.find('input[name="csrfmiddlewaretoken"]');
  var csrfToken = csrfTokenInput.val();
  var eventId = form.find('input[name="event-id"]');
  console.log("event id in submit is " + eventId.val());

  // Debugging logs
  console.log('Form:', form);
  console.log('CSRF Token Input:', csrfTokenInput);
  console.log('CSRF Token:', csrfToken);

  //var sourcePage= form.find('input[name="source_page"]').val();
  //console.log(sourcePage);

  if (!csrfToken) {
    alert("CSRF token not found!");
    return;
  }

  var formData = form.serialize();

  
  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        if (response.redirect_url) {
          window.location.href = response.redirect_url;
        } else {
          location.reload();  // Optionally, reload the page to reflect changes
        }
      } else if (response.status === 'error') {
        displayFormErrors(form, response.errors);
      }
    },
    error: function(xhr, status, error) {
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}
function displayFormErrors(form, errors) {
  form.find('.form-error').remove();
  $.each(errors, function(field, messages) {
    var fieldElement = form.find(`[name="${field}"]`);
    if (fieldElement.length > 0) {
      var errorList = $('<ul class="form-error text-danger"></ul>');
      $.each(messages, function(_, message) {
        errorList.append($('<li></li>').text(message));
      });
      fieldElement.after(errorList);
    } else if (field === '__all__') {
      var generalErrorList = $('<ul class="form-error text-danger"></ul>');
      $.each(messages, function(_, message) {
        generalErrorList.append($('<li></li>').text(message));
      });
      form.prepend(generalErrorList);
    }
  });
}

</script>
{% endblock %}