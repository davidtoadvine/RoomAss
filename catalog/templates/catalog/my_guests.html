{% extends "base_generic.html" %}

{% block content %}
<div class="container">
    <h1>{{ request.user }}'s Guests</h1>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Guest Name</th>
                <th>Start Date</th>
                <th>End Date</th>
      
                <th>Building / Section / Room #</th>
                <th>Owner</th>
                <th>Available Until</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if not occupancy_events %}
                <tr>
                    <td colspan="6">No guests currently booked.</td>
                </tr>
            {% else %}
                {% for o_event in occupancy_events %}

                <tr>
                    <td>{{ o_event.guest_name }}</td>
                    <td>{{ o_event.start_date|date:"F d" }}</td>
                    <td>{{ o_event.end_date|date:"F d" }}</td>
                    <td>
                        <button class="btn-link"
                                data-toggle="modal" 
                                data-target="#floorplanModal" 
                                data-image-url="{{ o_event.image_url }}"
                                onclick="showFloorplanModal('{{ o_event.room_image_url }}' , '{{o_event.room_name}}')">
                                {{ o_event.room_name }}
                        </button>
                    </td>
                    <td>{{o_event.room_owner}}</td>
                    <td>{{o_event.last_available|date:"F d, Y"}}</td>
                    <td>
                      <button class="btn btn-primary"
                              data-toggle="modal" 
                              data-target="#extend-modal-{{ o_event.id }}" 
                              data-id="{{ o_event.id }}" 
                              data-original-start="{{ o_event.start_date|date:'Y-m-d' }}" 
                              data-original-end="{{ o_event.end_date|date:'Y-m-d' }}"
                              data-image-url="{{ o_event.image_url }}">
                          Extend
                      </button>

                      <button class="btn btn-primary" 
                              data-toggle="modal" 
                              data-target="#shorten-modal-{{ o_event.id }}" 
                              data-id="{{ o_event.id }}" 
                              data-original-start="{{ o_event.start_date|date:'Y-m-d' }}" 
                              data-original-end="{{ o_event.end_date|date:'Y-m-d' }}"
                              data-image-url="{{ o_event.image_url }}">
                          Shorten
                      </button>

                    <button class="btn btn-danger" 
                            data-toggle="modal" 
                            data-target="#delete-modal-{{ o_event.id }}" 
                            data-id="{{ o_event.id }}" 
                            data-original-start="{{ o_event.start_date|date:'Y-m-d' }}" 
                            data-original-end="{{ o_event.end_date|date:'Y-m-d' }}"
                            data-image-url="{{ o_event.image_url }}">
                        Delete
                    </button>
                    {%include "occupancy_modals.html"%}

                    </td>
                </tr>

{%include "floorplan_img_modal.html"%}

{% endfor %}
{% endif %}
</tbody>
</table>
</div>

<script>
  $(document).ready(function() {
    
  // Populate the extend and shorten modals with the event data
  $('.modal').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget);
    var startDate = button.data('original-start');
    var endDate = button.data('original-end');
    var eventId = button.data('id');
    var modal = $(this);


    // Store the eventId in the modal's data attribute
    modal.data('event-id', eventId);

    // For Extend Modal
    modal.find(`#extend-start-date-${eventId}`).val(startDate).attr('data-original-start', startDate);
    modal.find(`#extend-end-date-${eventId}`).val(endDate).attr('data-original-end', endDate);

    // For Shorten Modal
    modal.find(`#shorten-start-date-${eventId}`).val(startDate).attr('data-original-start', startDate);
    modal.find(`#shorten-end-date-${eventId}`).val(endDate).attr('data-original-end', endDate);

    // Set the event_id field value explicitly
    modal.find(`#extend-event-id-${eventId}`).val(eventId);
    modal.find(`#shorten-event-id-${eventId}`).val(eventId);

    modal.find(`#delete-event-id-${eventId}`).val(eventId);
  });
 // Add the validation functions here (validateExtendDate and validateShortenDate)...
  // Function to validate date selection
  function validateExtendDate(eventId) {
    console.log(`Validating extend date for event ${eventId}`);
    let startDateInput = document.getElementById(`extend-start-date-${eventId}`);
    let endDateInput = document.getElementById(`extend-end-date-${eventId}`);
    let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
    let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
    let newStartDate = new Date(startDateInput.value);
    let newEndDate = new Date(endDateInput.value);
  
    if (newStartDate > originalStartDate || newEndDate < originalEndDate) {
      alert("New dates cannot shrink the original reservation window. Please use the 'Shorten' button for that.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    }
    return true;
  }
  
  
  
  function validateShortenDate(eventId) {
    console.log(eventId)
    console.log(`Validating shorten date for event ${eventId}`);
    let startDateInput = document.getElementById(`shorten-start-date-${eventId}`);
    let endDateInput = document.getElementById(`shorten-end-date-${eventId}`);
    let originalStartDate = new Date(startDateInput.getAttribute('data-original-start'));
    let originalEndDate = new Date(endDateInput.getAttribute('data-original-end'));
    let newStartDate = new Date(startDateInput.value);
    let newEndDate = new Date(endDateInput.value);
  
    if (newStartDate < originalStartDate || newEndDate > originalEndDate) {
      alert("New dates cannot extend the original reservation window. Please use the 'Extend' button for that.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    }
    else if (newStartDate >= originalEndDate || newEndDate <= originalStartDate){
      alert("The start date cannot occur on or after the end date. If you wish to delete this event, please use the 'Delete' button.");
      startDateInput.value = startDateInput.getAttribute('data-original-start');
      endDateInput.value = endDateInput.getAttribute('data-original-end');
      return false;
    }
    return true;
  } 
  // Attach change event listeners to the date inputs
$(document).on('change', '.shorten-start-date, .shorten-end-date', function() {
  const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
  console.log(eventId)
  validateShortenDate(eventId);
});
// Attach change event listeners to the date inputs
$(document).on('change', '.extend-start-date, .extend-end-date', function() {
  const eventId = $(this).closest('.modal').find('input[name="event_id"]').val();
  console.log(eventId)
  validateExtendDate(eventId);
});





  // Prevent form submission if validation fails
  $(document).on('submit', 'form[data-form-type]', function(e) {
    e.preventDefault(); // Prevent the default form submission
    const form = $(this);
    const eventId = form.find('input[name="event_id"]').val();
    const formType = form.attr('data-form-type');

    if ((formType === 'extend' && validateExtendDate(eventId)) || 
      (formType === 'shorten' && validateShortenDate(eventId)) || 
      formType === 'delete') { // No validation for delete, just submit
    $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: form.serialize(),
        success: function(response) {
          if (response.status === 'success') {
            if (response.redirect_url) {
              window.location.href = response.redirect_url; // Redirect to the URL provided in the response
            } else {
              // Handle the case where no redirect URL is provided (update the modal or page content as needed)
              alert('Booking updated successfully');
            }
          } else if (response.status === 'error') {
            displayFormErrors(form, response.errors);
          } else if (response.status === 'conflict') {
            // Handle conflict response if necessary
            alert('There is a conflict with the new dates.');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error:', error);
          alert('An error occurred while processing your request. Please try again.');
        }
      });
    }
  });

  


});

// Function to submit extend form
function submitExtendForm(eventId) {
  var form = $(`#extend-form-${eventId}`);
  var formData = form.serialize();

  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        // Redirect to the appropriate URL
        window.location.href = response.redirect_url;
      } else if (response.status === 'error') {
        // Display errors in the modal
        displayFormErrors(form, response.errors);
      } else if (response.status === 'conflict') {
        // Handle conflict
        alert(`Conflict detected: Start - ${response.start}, End - ${response.end}`);
      }
    },
    error: function(xhr, status, error) {
      // Handle the error
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}

// Function to submit shorten form
function submitShortenForm(eventId) {
  var form = $(`#shorten-form-${eventId}`);
  var formData = form.serialize();
  var csrfToken = form.find('[name="csrfmiddlewaretoken"]').val();
  console.log("CSRF Token:", csrfToken);

  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        // Redirect to the appropriate URL
        window.location.href = response.redirect_url;
      } else if (response.status === 'error') {
        // Display errors in the modal
        displayFormErrors(form, response.errors);
      } else if (response.status === 'conflict') {
        // Handle conflict
        alert(`Conflict detected: Start - ${response.start}, End - ${response.end}`);
      }
    },
    error: function(xhr, status, error) {
      // Handle the error
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}

// Function to submit delete form
function submitDeleteForm(eventId) {
  console.log("SUBMITTING DELETE FORM")
  var form = $(`#delete-event-form-${eventId}`);
  console.log(form)
  var csrfTokenInput = form.find('input[name="csrfmiddlewaretoken"]');
  var csrfToken = csrfTokenInput.val();

  // Debugging logs
  console.log('Form:', form);
  console.log('CSRF Token Input:', csrfTokenInput);
  console.log('CSRF Token:', csrfToken);

  //var sourcePage= form.find('input[name="source_page"]').val();
  //console.log(sourcePage);

  if (!csrfToken) {
    alert("CSRF token not found!");
    return;
  }

  var formData = form.serialize();

  
  $.ajax({
    type: "POST",
    url: form.attr('action'),
    data: formData,
    success: function(response) {
      if (response.status === 'success') {
        // Redirect to the appropriate URL
        window.location.href = response.redirect_url;
      } else if (response.status === 'error') {
        // Display errors in the modal
        displayFormErrors(form, response.errors);
      } 
    },
    error: function(xhr, status, error) {
      // Handle the error
      console.error("An error occurred:", status, error);
      alert("An error occurred while submitting the form. Please try again.");
    }
  });
}

// Display form errors in the modal
function displayFormErrors(form, errors) {
  // Clear previous errors
  form.find('.form-error').remove();

  // Display new errors
  $.each(errors, function(field, messages) {
    const input = form.find(`[name="${field}"]`);
    if (input.length) {
      const errorHtml = `<div class="form-error text-danger">${messages.join('<br>')}</div>`;
      input.after(errorHtml);
    }
  });
}
</script>
{% endblock %}